name: Build & Deploy Sphinx (docs branch + main code)

on:
push:
branches: [ main ]
pull_request:
branches: [ main ]
workflow_dispatch:

permissions:
contents: read
pages: write
id-token: write

concurrency:
group: "pages"
cancel-in-progress: false

jobs:
build:
runs-on: ubuntu-latest
steps:
# Checkout main branch (main code)
- name: Checkout main code
uses: actions/checkout@v5
with:
path: repo

  # Checkout docs branch (Sphinx sources)
  - name: Checkout docs branch
    uses: actions/checkout@v5
    with:
      ref: docu
      path: docs-src

  # Set up Python
  - name: Set up Python
    uses: actions/setup-python@v5
    with:
      python-version: "3.11"
      cache: "pip"
      cache-dependency-path: "docs-src/requirements-docs.txt"

  # Install dependencies
  - name: Install doc dependencies
    run: |
      python -m pip install --upgrade pip
      pip install -r docs-src/requirements-docs.txt
      pip install matplotlib  # any additional dependencies your code needs
      echo "PYTHONPATH=${GITHUB_WORKSPACE}/repo:$PYTHONPATH" >> $GITHUB_ENV

  # Sanity import check
  - name: Sanity import check
    run: |
      python - <<'PY'
      import os, sys
      code_dir = os.environ.get("PYTHONPATH")
      print("PYTHONPATH:", code_dir)
      sys.path.insert(0, code_dir)
      import Constructor.Constructor
      print("Imported Constructor module:", getattr(Constructor.Constructor, "__file__", None))
      PY

  # Build Sphinx HTML
  - name: Build Sphinx HTML
    env:
      PYTHONPATH: ${{ github.workspace }}/repo
    run: sphinx-build -b html docs-src _site

  # Upload Pages artifact
  - name: Upload Pages artifact
    uses: actions/upload-pages-artifact@v3
    with:
      path: _site